# Time-calibrated mtDNA phylogeny with BEAST2

This page describes the pipeline used to estimate a phylogenetic tree from the *Ceratopipra rubrocapilla* mtDNA sequence data using BEAST.  

First, we need to set up an xml file with all the parameters for our analysis. The easiest way to do this is in Beauti, a program that comes with the BEAST suite of programs.  

# relaxed clock, gamma sitse model

This analysis will used an optimized relaxed clock, to account for possible differences in mutation rate that have occurred across our branches. Our maximum likelihood tree showed some branches sticking out farther than others, so it looks like some haplotypes have experienced more mutations than others (possibly due to chance).  

Within Beauti v2.7.5, I openned the alignment:  
```
File -> Import alignment -> Ceratopipra/2_Phylogeny/2.4aa_ML_mtDNAtree/datasets/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.renamed.fasta -> nucleotide -> ok
```
This alignment has:  
* 954 bp  
* 142 taxa (139 *C. rubrocapilla* and 3 outgroup *C. chloromeros*)  
Next, I changed a few of the default settings:  
Site model: Gamma site model  
* Subst model: GTR  
* Gamma category count: 4  
Clock model: Optimized relaxed clock  
* Clock.rate: 0.0105  
Chain length: 100000000  
All other settings were kept at the defaults. Then, I saved it as an xml file:  
File -> Save as -> 2.5aa_BEAST_mtDNAtree/datasets/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.xml  

We now just need to give this xml file to BEAST and it will run with our chosen parameters.  

```bash
cd /home/1_Else/Ceratopipra/2_Phylogeny/2.5aa_BEAST_mtDNAtree

#setup environment for BEAST. I need to add the beagle library to my LD_LIBRARY_PATH. I have this installed through conda.
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH

#setup a directory to hold the results
mkdir -p Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill && cd Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill

#run three replicates starting from different starting seeds.
mkdir -p run_1 && cd run_1 && time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/beast -seed 1234 -threads 20 ../../datasets/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.xml #1026m51.283s (3657m59.045s)
cd ..
mkdir -p run_2 && cd run_2 && time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/beast -seed 6294 -threads 20 ../../datasets/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.xml
cd ..
mkdir -p run_3 && cd run_3 && time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/beast -seed 3200 -threads 20 ../../datasets/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.xml


#generate a maximum clade credibility tree from the sample of trees. Set 10% of the dataset as burnin
#there are a few ways to pick the node ages used in the final tree based on the distribution in the sample. We could use mean, median, or common ancestor heights. Let's compare all three to ensure that our interpretations are robust to this choice.
time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/treeannotator -heights mean -lowMem -burnin 10 Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.trees Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.burn10.meanheights.tree #1 second
time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/treeannotator -heights median -lowMem -burnin 10 Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.trees Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.burn10.medianheights.tree #1 second
time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/treeannotator -heights ca -lowMem -burnin 10 Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.trees Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.burn10.caheights.tree #1 second
#Total number of trees 100001, where 90001 are used.
#all three options produce qualitatively similar results


#combine results from the three runs, removing the first 10% of each run as burn-in
#combine log files
cd /home/1_Else/Ceratopipra/2_Phylogeny/2.5aa_BEAST_mtDNAtree/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/logcombiner -log run_1/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.log -log run_2/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.log -log run_3/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.log -o Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.3_runs.log -b 10
#combine trees
time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/logcombiner -log run_1/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.trees -log run_2/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.trees -log run_3/Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.trees -o Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.3_runs.trees -b 10


#generate a maximum clade credibility tree from the sample of trees. 
#no burnin as burnin was already discarded
#there are a few ways to pick the node ages used in the final tree based on the distribution in the sample. We could use mean, median, or common ancestor heights. Let's compare all three to ensure that our interpretations are robust to this choice.
time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/treeannotator -heights mean -lowMem -burnin 0 Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.3_runs.trees Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.3_runs.meanheights.tree #25m6.736s
time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/treeannotator -heights median -lowMem -burnin 0 Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.3_runs.trees Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.3_runs.medianheights.tree #24m44.751s
time /home/0_PROGRAMS/beast_v2.7.5/beast/bin/treeannotator -heights ca -lowMem -burnin 0 Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.3_runs.trees Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill-Crubrocapilla_Cytb954bp_filtered_3chloromerosout.3_runs.caheights.tree #40m43.990s (131m12.133s)
#Total number of trees 270003, where 270003 are used.


```
* `-heights an option of 'ca' (default), 'median', 'mean' or 'keep'`
* `-burnin the percentage of states to be considered as 'burn-in'`
* `-lowMem use less memory, which is a bit slower.`

I openned the log files from each of the three runs in Tracer to ensure that all ESS values were above 200; they are all well above 200 (the lowest (likelihood) in the 600s, most of them in the thousands)

Mean, median, and common ancestor heights produce qualitatively similar results, though mean and median heights produced a couple negative branch lengths at poorly-supported nodes (this is because they only take the mean/median heights from trees that contain a given clade, meaning that different nodes may be estimated using a different subset of trees).  

I saved a figure using FigTree. I added node bars (Node bars -> CAheight_95%HPD) and node labels (Node labels -> posterior)


# Appendix
Output for Crubrocapilla_Cytb954bp_filtered_3chloromerosout.GTR.ORC.100mill.xml:  
```
Operator                                                                                                                    Tuning    #accept    #reject      Pr(m)  Pr(acc|m)
kernel.BactrianScaleOperator(YuleBirthRateScaler.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                       0.19732     778750    1894222    0.02670    0.29134 
kernel.BactrianScaleOperator(YuleModelTreeRootScaler.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   0.27413     639228    2029920    0.02670    0.23949 
kernel.BactrianNodeOperator(YuleModelUniformOperator.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   3.34960    8177820   18528381    0.26702    0.30621 
kernel.BactrianSubtreeSlide(YuleModelSubtreeSlide.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                      0.84297      18468   13332981    0.13351    0.00138 Try decreasing size to about 0.421
Exchange(YuleModelNarrow.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                                     -    9392939    3954599    0.13351    0.70372 
Exchange(YuleModelWide.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                                       -     104781    2567212    0.02670    0.03921 
WilsonBalding(YuleModelWilsonBalding.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                         -     168735    2504390    0.02670    0.06312 
EpochFlexOperator(YuleModelBICEPSEpochTop.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                              0.29276     543839    1235486    0.01780    0.30564 
EpochFlexOperator(YuleModelBICEPSEpochAll.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                              0.29222     546269    1234404    0.01780    0.30678 
TreeStretchOperator(YuleModelBICEPSTreeFlex.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                            0.11358     740220    1038198    0.01780    0.41622 Try setting scale factor to about 0.118
AdaptableOperatorSampler(RateACScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      12952      31265    0.00045    0.29292 
AdaptableOperatorSampler(RateAGScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      11826      33139    0.00045    0.26300 
AdaptableOperatorSampler(RateATScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      14303      30339    0.00045    0.32039 
AdaptableOperatorSampler(RateCGScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      24168      20575    0.00045    0.54015 
AdaptableOperatorSampler(RateGTScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      13172      31267    0.00045    0.29641 
AdaptableOperatorSampler(FrequenciesExchanger.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                -      10514      34030    0.00045    0.23604 
AdaptableOperatorSampler(gammaShapeScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                    -       8117      36476    0.00045    0.18202 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_sigma.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   -     762476    1908305    0.02670    0.28549 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_rates_root.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)              -     295959     595066    0.00890    0.33216 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_rates_internal.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)          -    5013704   12784137    0.17802    0.28170 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_NER.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                     -    5578880    3318489    0.08901    0.62703 

     Tuning: The value of the operator's tuning parameter, or '-' if the operator can't be optimized.
    #accept: The total number of times a proposal by this operator has been accepted.
    #reject: The total number of times a proposal by this operator has been rejected.
      Pr(m): The probability this operator is chosen in a step of the MCMC (i.e. the normalized weight).
  Pr(acc|m): The acceptance probability (#accept as a fraction of the total proposals for this operator).


Total calculation time: 61610.1 seconds
End likelihood: -2405.991830906408
Done!


Run 2:  

Operator                                                                                                                    Tuning    #accept    #reject      Pr(m)  Pr(acc|m)
kernel.BactrianScaleOperator(YuleBirthRateScaler.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                       0.19657     783539    1887725    0.02670    0.29332 
kernel.BactrianScaleOperator(YuleModelTreeRootScaler.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   0.27030     655051    2014120    0.02670    0.24541 
kernel.BactrianNodeOperator(YuleModelUniformOperator.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   3.34962    8170253   18529547    0.26702    0.30600 
kernel.BactrianSubtreeSlide(YuleModelSubtreeSlide.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                      0.67197      25689   13325870    0.13351    0.00192 Try decreasing size to about 0.336
Exchange(YuleModelNarrow.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                                     -    9390808    3959064    0.13351    0.70344 
Exchange(YuleModelWide.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                                       -     104733    2564240    0.02670    0.03924 
WilsonBalding(YuleModelWilsonBalding.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                         -     168029    2504233    0.02670    0.06288 
EpochFlexOperator(YuleModelBICEPSEpochTop.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                              0.29720     535475    1243830    0.01780    0.30095 
EpochFlexOperator(YuleModelBICEPSEpochAll.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                              0.28917     552586    1228640    0.01780    0.31023 
TreeStretchOperator(YuleModelBICEPSTreeFlex.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                            0.11407     731429    1048467    0.01780    0.41094 Try setting scale factor to about 0.117
AdaptableOperatorSampler(RateACScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      12408      31912    0.00045    0.27996 
AdaptableOperatorSampler(RateAGScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      11853      32522    0.00045    0.26711 
AdaptableOperatorSampler(RateATScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      11268      32912    0.00045    0.25505 
AdaptableOperatorSampler(RateCGScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      25236      19316    0.00045    0.56644 
AdaptableOperatorSampler(RateGTScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      14060      30674    0.00045    0.31430 
AdaptableOperatorSampler(FrequenciesExchanger.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                -       7980      36402    0.00045    0.17980 
AdaptableOperatorSampler(gammaShapeScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                    -       6048      38366    0.00045    0.13617 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_sigma.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   -     756741    1913753    0.02670    0.28337 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_rates_root.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)              -     287295     602940    0.00890    0.32272 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_rates_internal.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)          -    4930374   12872071    0.17802    0.27695 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_NER.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                     -    5574751    3327791    0.08901    0.62620 

     Tuning: The value of the operator's tuning parameter, or '-' if the operator can't be optimized.
    #accept: The total number of times a proposal by this operator has been accepted.
    #reject: The total number of times a proposal by this operator has been rejected.
      Pr(m): The probability this operator is chosen in a step of the MCMC (i.e. the normalized weight).
  Pr(acc|m): The acceptance probability (#accept as a fraction of the total proposals for this operator).


Total calculation time: 82680.663 seconds
End likelihood: -2506.960036108078

Run 3:

Operator                                                                                                                    Tuning    #accept    #reject      Pr(m)  Pr(acc|m)
kernel.BactrianScaleOperator(YuleBirthRateScaler.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                       0.19673     785905    1885683    0.02670    0.29417 
kernel.BactrianScaleOperator(YuleModelTreeRootScaler.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   0.27465     635847    2032033    0.02670    0.23833 
kernel.BactrianNodeOperator(YuleModelUniformOperator.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   3.34545    8195901   18499109    0.26702    0.30702 
kernel.BactrianSubtreeSlide(YuleModelSubtreeSlide.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                      1.59598       8242   13347525    0.13351    0.00062 Try decreasing size to about 0.798
Exchange(YuleModelNarrow.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                                     -    9397791    3950965    0.13351    0.70402 
Exchange(YuleModelWide.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                                       -     104849    2562343    0.02670    0.03931 
WilsonBalding(YuleModelWilsonBalding.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                         -     167690    2502741    0.02670    0.06280 
EpochFlexOperator(YuleModelBICEPSEpochTop.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                              0.29363     544372    1237058    0.01780    0.30558 
EpochFlexOperator(YuleModelBICEPSEpochAll.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                              0.28491     561332    1220715    0.01780    0.31499 
TreeStretchOperator(YuleModelBICEPSTreeFlex.t:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                            0.11347     739707    1041651    0.01780    0.41525 Try setting scale factor to about 0.118
AdaptableOperatorSampler(RateACScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      13390      31371    0.00045    0.29914 
AdaptableOperatorSampler(RateAGScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      11306      33187    0.00045    0.25411 
AdaptableOperatorSampler(RateATScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      12272      31860    0.00045    0.27807 
AdaptableOperatorSampler(RateCGScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      17884      26853    0.00045    0.39976 
AdaptableOperatorSampler(RateGTScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                        -      14253      30034    0.00045    0.32183 
AdaptableOperatorSampler(FrequenciesExchanger.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                -      10556      34019    0.00045    0.23681 
AdaptableOperatorSampler(gammaShapeScaler.s:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                                    -       7995      35968    0.00045    0.18186 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_sigma.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                   -     756030    1915803    0.02670    0.28296 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_rates_root.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)              -     284576     604976    0.00890    0.31991 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_rates_internal.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)          -    5045116   12758033    0.17802    0.28338 
AdaptableOperatorSampler(ORCAdaptableOperatorSampler_NER.c:Crubrocapilla_Cytb954bp_filtered_3chloromerosout)                     -    5581940    3321120    0.08901    0.62697 

     Tuning: The value of the operator's tuning parameter, or '-' if the operator can't be optimized.
    #accept: The total number of times a proposal by this operator has been accepted.
    #reject: The total number of times a proposal by this operator has been rejected.
      Pr(m): The probability this operator is chosen in a step of the MCMC (i.e. the normalized weight).
  Pr(acc|m): The acceptance probability (#accept as a fraction of the total proposals for this operator).


Total calculation time: 69609.653 seconds
End likelihood: -2486.785584396378
Done!

real  1160m10.730s
user  4015m53.348s
sys 341m2.577s

```
